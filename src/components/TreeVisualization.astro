---
// This component will render the D3.js tree visualization
// The logic will be handled in client-side script
---

<div id="tree-container"></div>

<script>
// @ts-nocheck
import * as d3 from 'd3';
import { treeData } from '../data/treedata.js';

function initTree() {
    const treeContainer = document.getElementById('tree-container');
    if (!treeContainer) return;

    // Evitar múltiples SVG en HMR / recargas parciales
    treeContainer.innerHTML = '';

// Configuración del árbol D3.js
const margin = { top: 20, right: 120, bottom: 20, left: 250 };
const containerWidth = Math.max(treeContainer.clientWidth || window.innerWidth, 320);
const width = Math.max(containerWidth - margin.left - margin.right, 100);
const height = 800 - margin.top - margin.bottom;

let i = 0;
let duration = 750;
let root;

// Crear el árbol D3
const tree = d3.tree().size([height, width]);

// Crear el elemento SVG
const svg = d3.select("#tree-container")
    .append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
    .append("g")
    .attr("transform", `translate(${margin.left},${margin.top})`);

// Inicializar el árbol
root = d3.hierarchy(treeData, d => d.children);
root.x0 = height / 2;
root.y0 = 0;

// Colapsar todos los nodos excepto el primero
if (root.children) {
    root.children.forEach(collapse);
}

update(root);

// Función para colapsar nodos
function collapse(d) {
    if (d.children) {
        d._children = d.children;
        d._children.forEach(collapse);
        d.children = null;
    }
}

// Función para expandir nodos
function expand(d) {
    if (d._children) {
        d.children = d._children;
        d._children = null;
    }

    if (d.children) {
        d.children.forEach(expand);
    }
}

// Función principal de actualización
function update(source) {
    // Asignar posiciones a los nodos
    const treeData = tree(root);
    const nodes = treeData.descendants();
    const links = treeData.descendants().slice(1);

    // Normalizar la posición Y
    nodes.forEach(d => { d.y = d.depth * 180; });

    // Actualizar nodos
    const node = svg.selectAll('g.node')
        .data(nodes, d => d.id || (d.id = ++i));

    // Entrar en nuevos nodos
    const nodeEnter = node.enter().append('g')
        .attr('class', d => d.data.url ? 'node leaf' : 'node')
        .attr('transform', d => `translate(${source.y0},${source.x0})`)
        .on('click', click);

    // Agregar círculos
    nodeEnter.append('circle')
        .attr('r', 1e-6)
        .style('fill', d => d._children ? "#00d4ff" : d.data.url ? "#ff6b6b" : "#fff");

    // Agregar texto
    nodeEnter.append('text')
        .attr('dy', '.35em')
        .attr('x', d => d.children || d._children ? -13 : 13)
        .attr('text-anchor', d => d.children || d._children ? 'end' : 'start')
        .text(d => d.data.name);

    // Transición de nodos
    const nodeUpdate = nodeEnter.merge(node);

    nodeUpdate.transition()
        .duration(duration)
        .attr('transform', d => `translate(${d.y},${d.x})`);

    nodeUpdate.select('circle')
        .attr('r', 6)
        .style('fill', d => d._children ? "#00d4ff" : d.data.url ? "#ff6b6b" : "#fff")
        .attr('cursor', 'pointer');

    // Transición de salida
    const nodeExit = node.exit().transition()
        .duration(duration)
        .attr('transform', d => `translate(${source.y},${source.x})`)
        .remove();

    nodeExit.select('circle')
        .attr('r', 1e-6);

    nodeExit.select('text')
        .style('fill-opacity', 1e-6);

    // Actualizar enlaces
    const link = svg.selectAll('path.link')
        .data(links, d => d.id);

    // Entrar en nuevos enlaces
    const linkEnter = link.enter().insert('path', 'g')
        .attr('class', 'link')
        .attr('d', d => {
            const o = { x: source.x0, y: source.y0 };
            return diagonal(o, o);
        });

    // Transición de enlaces
    const linkUpdate = linkEnter.merge(link);

    linkUpdate.transition()
        .duration(duration)
        .attr('d', d => diagonal(d, d.parent));

    // Transición de salida de enlaces
    link.exit().transition()
        .duration(duration)
        .attr('d', d => {
            const o = { x: source.x, y: source.y };
            return diagonal(o, o);
        })
        .remove();

    // Guardar posición antigua para la transición
    nodes.forEach(d => {
        d.x0 = d.x;
        d.y0 = d.y;
    });
}

// Función para crear enlaces curvos
function diagonal(s, d) {
    return `M ${s.y} ${s.x}
            C ${(s.y + d.y) / 2} ${s.x},
              ${(s.y + d.y) / 2} ${d.x},
              ${d.y} ${d.x}`;
}

// Función de clic
function click(d) {
    if (d.data.url) {
        // Si es un enlace, abrir en nueva pestaña
        window.open(d.data.url, '_blank');
    } else {
        // Si es una categoría, expandir/colapsar
        if (d.children) {
            d._children = d.children;
            d.children = null;
        } else {
            d.children = d._children;
            d._children = null;
        }
        update(d);
    }
}

// Funcionalidad de búsqueda
const searchBox = document.getElementById('searchBox');
searchBox.addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    
    if (searchTerm === '') {
        // Restablecer todos los nodos
        svg.selectAll('g.node').classed('hidden', false);
        svg.selectAll('path.link').classed('hidden', false);
        return;
    }

    // Buscar y resaltar coincidencias
    svg.selectAll('g.node').each(function(d) {
        const node = d3.select(this);
        const matches = d.data.name.toLowerCase().includes(searchTerm);
        node.classed('hidden', !matches);
    });

    svg.selectAll('path.link').each(function(d) {
        const link = d3.select(this);
        const matches = d.data.name.toLowerCase().includes(searchTerm);
        link.classed('hidden', !matches);
    });
});

// Botón de expandir todo
document.getElementById('expandAllBtn').addEventListener('click', function() {
    expand(root);
    update(root);
});

// Botón de colapsar todo
document.getElementById('collapseAllBtn').addEventListener('click', function() {
    if (root.children) {
        root.children.forEach(collapse);
    }
    update(root);
});

// Hacer el SVG responsivo
window.addEventListener('resize', function() {
    const newContainerWidth = Math.max(treeContainer.clientWidth || window.innerWidth, 320);
    const newWidth = Math.max(newContainerWidth - margin.left - margin.right, 100);
    d3.select("#tree-container svg")
        .attr("width", newWidth + margin.left + margin.right);
});

}

if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initTree);
} else {
    initTree();
}
</script>

<style>
  #tree-container {
    margin: 30px 0;
    overflow-x: auto;
    overflow-y: hidden;
    background-color: #1a1a1a;
    border-radius: 8px;
    padding: 20px 60px;
    min-height: 500px;
    width: 100%;
  }

  :global(.node circle) {
    fill: #00d4ff;
    stroke: #00a8cc;
    stroke-width: 2px;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  :global(.node circle:hover) {
    fill: #00ffdd;
    stroke: #00d4ff;
    stroke-width: 3px;
    filter: drop-shadow(0 0 8px rgba(0, 212, 255, 0.6));
  }

  :global(.node.leaf circle) {
    fill: #ff6b6b;
    stroke: #ff5252;
  }

  :global(.node.leaf circle:hover) {
    fill: #ff8787;
    stroke: #ff6b6b;
    filter: drop-shadow(0 0 8px rgba(255, 107, 107, 0.6));
  }

  :global(.node text) {
    font: 14px 'Segoe UI', sans-serif;
    fill: #e0e0e0;
    cursor: pointer;
    user-select: none;
  }

  :global(.node.leaf text) {
    fill: #ff6b6b;
    font-weight: 500;
  }

  :global(.node text:hover) {
    fill: #00ffdd;
  }

  :global(.link) {
    fill: none;
    stroke: #555;
    stroke-width: 2px;
    stroke-opacity: 0.6;
  }

  :global(.link:hover) {
    stroke: #00d4ff;
    stroke-opacity: 1;
    stroke-width: 3px;
  }

  :global(.node.hidden) {
    opacity: 0.2;
  }

  :global(.link.hidden) {
    opacity: 0.1;
  }

  @media (max-width: 768px) {
    :global(.node text) {
      font-size: 12px;
    }
  }
</style>
