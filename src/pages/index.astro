---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import SearchBar from '../components/SearchBar.astro';
import TreeVisualization from '../components/TreeVisualization.astro';
import Footer from '../components/Footer.astro';
---

<Layout>
	<Header />
	<SearchBar />
	<p style="text-align: center; margin: 20px 0;">Haz clic en los nodos para expandir/contraer | Los enlaces externos se abren en nueva pestaña</p>
	<TreeVisualization />
	<Footer />
</Layout>

<script>
// @ts-nocheck
import * as d3 from 'd3';

function initTree() {
    const treeContainer = document.getElementById('tree-container');
    if (!treeContainer) return;

    // Evitar múltiples SVG en HMR / recargas parciales
    treeContainer.innerHTML = '';

// Datos de ejemplo - Estructura jerárquica de recursos de aprendizaje
const treeData = {
    name: "Recursos de Aprendizaje",
    children: [
        {
            name: "Ciberseguridad",
            children: [
                {
                    name: "CTFs",
                    children: [
                        { name: "HackTheBox", url: "https://www.hackthebox.com" },
                        { name: "TryHackMe", url: "https://tryhackme.com" },
                        { name: "PicoCTF", url: "https://picoctf.org" },
                        { name: "Root Me", url: "https://www.root-me.org" }
                    ]
                },
                {
                    name: "Cursos",
                    children: [
                        { name: "Cybrary", url: "https://www.cybrary.it" },
                        { name: "OWASP", url: "https://owasp.org" },
                        { name: "PortSwigger Academy", url: "https://portswigger.net/web-security" }
                    ]
                },
                {
                    name: "Herramientas",
                    children: [
                        { name: "Kali Linux", url: "https://www.kali.org" },
                        { name: "Metasploit", url: "https://www.metasploit.com" },
                        { name: "Wireshark", url: "https://www.wireshark.org" }
                    ]
                }
            ]
        },
        {
            name: "Desarrollo",
            children: [
                {
                    name: "Frontend",
                    children: [
                        { name: "freeCodeCamp", url: "https://www.freecodecamp.org" },
                        { name: "MDN Web Docs", url: "https://developer.mozilla.org" },
                        { name: "CSS-Tricks", url: "https://css-tricks.com" },
                        { name: "JavaScript.info", url: "https://javascript.info" }
                    ]
                },
                {
                    name: "Backend",
                    children: [
                        { name: "Node.js Docs", url: "https://nodejs.org/docs" },
                        { name: "Django Tutorial", url: "https://docs.djangoproject.com" },
                        { name: "Spring Guides", url: "https://spring.io/guides" },
                        { name: "FastAPI", url: "https://fastapi.tiangolo.com" }
                    ]
                },
                {
                    name: "DevOps",
                    children: [
                        { name: "Docker Docs", url: "https://docs.docker.com" },
                        { name: "Kubernetes", url: "https://kubernetes.io/docs" },
                        { name: "GitHub Actions", url: "https://docs.github.com/actions" }
                    ]
                }
            ]
        },
        {
            name: "Diseño",
            children: [
                {
                    name: "UI/UX",
                    children: [
                        { name: "Laws of UX", url: "https://lawsofux.com" },
                        { name: "Nielsen Norman Group", url: "https://www.nngroup.com" },
                        { name: "Interaction Design", url: "https://www.interaction-design.org" }
                    ]
                },
                {
                    name: "Herramientas",
                    children: [
                        { name: "Figma", url: "https://www.figma.com" },
                        { name: "Adobe Color", url: "https://color.adobe.com" },
                        { name: "Canva", url: "https://www.canva.com" }
                    ]
                },
                {
                    name: "Recursos Gráficos",
                    children: [
                        { name: "Unsplash", url: "https://unsplash.com" },
                        { name: "Flaticon", url: "https://www.flaticon.com" },
                        { name: "Google Fonts", url: "https://fonts.google.com" }
                    ]
                }
            ]
        },
        {
            name: "Ciencias",
            children: [
                {
                    name: "Matemáticas",
                    children: [
                        { name: "Khan Academy", url: "https://www.khanacademy.org/math" },
                        { name: "Brilliant", url: "https://brilliant.org" },
                        { name: "3Blue1Brown", url: "https://www.3blue1brown.com" },
                        { name: "MIT OpenCourseWare", url: "https://ocw.mit.edu/courses/mathematics" }
                    ]
                },
                {
                    name: "Física",
                    children: [
                        { name: "Physics Classroom", url: "https://www.physicsclassroom.com" },
                        { name: "HyperPhysics", url: "http://hyperphysics.phy-astr.gsu.edu" },
                        { name: "Feynman Lectures", url: "https://www.feynmanlectures.caltech.edu" }
                    ]
                },
                {
                    name: "Psicología",
                    children: [
                        { name: "Simply Psychology", url: "https://www.simplypsychology.org" },
                        { name: "Psychology Today", url: "https://www.psychologytoday.com" },
                        { name: "Coursera Psychology", url: "https://www.coursera.org/browse/social-sciences/psychology" }
                    ]
                }
            ]
        },
        {
            name: "Hardware",
            children: [
                {
                    name: "Arduino",
                    children: [
                        { name: "Arduino Docs", url: "https://docs.arduino.cc" },
                        { name: "Arduino Project Hub", url: "https://create.arduino.cc/projecthub" },
                        { name: "Adafruit Learn", url: "https://learn.adafruit.com" }
                    ]
                },
                {
                    name: "Electrónica",
                    children: [
                        { name: "All About Circuits", url: "https://www.allaboutcircuits.com" },
                        { name: "Electronics Tutorials", url: "https://www.electronics-tutorials.ws" },
                        { name: "SparkFun Tutorials", url: "https://learn.sparkfun.com" }
                    ]
                },
                {
                    name: "Raspberry Pi",
                    children: [
                        { name: "Raspberry Pi Docs", url: "https://www.raspberrypi.org/documentation" },
                        { name: "MagPi Magazine", url: "https://magpi.raspberrypi.org" },
                        { name: "Pi My Life Up", url: "https://pimylifeup.com" }
                    ]
                }
            ]
        }
    ]
};

// Configuración del árbol D3.js
const margin = { top: 20, right: 120, bottom: 20, left: 250 };
const containerWidth = Math.max(treeContainer.clientWidth || window.innerWidth, 320);
const width = Math.max(containerWidth - margin.left - margin.right, 100);
const height = 800 - margin.top - margin.bottom;

let i = 0;
let duration = 750;
let root;

// Crear el árbol D3
const tree = d3.tree().size([height, width]);

// Crear el elemento SVG
const svg = d3.select("#tree-container")
    .append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
    .append("g")
    .attr("transform", `translate(${margin.left},${margin.top})`);

// Inicializar el árbol
root = d3.hierarchy(treeData, d => d.children);
root.x0 = height / 2;
root.y0 = 0;

// Colapsar todos los nodos excepto el primero
if (root.children) {
    root.children.forEach(collapse);
}

update(root);

// Función para colapsar nodos
function collapse(d) {
    if (d.children) {
        d._children = d.children;
        d._children.forEach(collapse);
        d.children = null;
    }
}

// Función para expandir nodos
function expand(d) {
    if (d._children) {
        d.children = d._children;
        d.children.forEach(expand);
        d._children = null;
    }
}

// Función principal de actualización
function update(source) {
    // Asignar posiciones a los nodos
    const treeData = tree(root);
    const nodes = treeData.descendants();
    const links = treeData.descendants().slice(1);

    // Normalizar la posición Y
    nodes.forEach(d => { d.y = d.depth * 180; });

    // Actualizar nodos
    const node = svg.selectAll('g.node')
        .data(nodes, d => d.id || (d.id = ++i));

    // Entrar en nuevos nodos
    const nodeEnter = node.enter().append('g')
        .attr('class', d => d.data.url ? 'node leaf' : 'node')
        .attr('transform', d => `translate(${source.y0},${source.x0})`)
        .on('click', click);

    // Agregar círculos
    nodeEnter.append('circle')
        .attr('r', 1e-6)
        .style('fill', d => d._children ? "#00d4ff" : d.data.url ? "#ff6b6b" : "#fff");

    // Agregar texto
    nodeEnter.append('text')
        .attr('dy', '.35em')
        .attr('x', d => d.children || d._children ? -13 : 13)
        .attr('text-anchor', d => d.children || d._children ? 'end' : 'start')
        .text(d => d.data.name);

    // Transición de nodos
    const nodeUpdate = nodeEnter.merge(node);

    nodeUpdate.transition()
        .duration(duration)
        .attr('transform', d => `translate(${d.y},${d.x})`);

    nodeUpdate.select('circle')
        .attr('r', 6)
        .style('fill', d => d._children ? "#00d4ff" : d.data.url ? "#ff6b6b" : "#fff")
        .attr('cursor', 'pointer');

    // Transición de salida
    const nodeExit = node.exit().transition()
        .duration(duration)
        .attr('transform', d => `translate(${source.y},${source.x})`)
        .remove();

    nodeExit.select('circle')
        .attr('r', 1e-6);

    nodeExit.select('text')
        .style('fill-opacity', 1e-6);

    // Actualizar enlaces
    const link = svg.selectAll('path.link')
        .data(links, d => d.id);

    // Entrar en nuevos enlaces
    const linkEnter = link.enter().insert('path', 'g')
        .attr('class', 'link')
        .attr('d', d => {
            const o = { x: source.x0, y: source.y0 };
            return diagonal(o, o);
        });

    // Transición de enlaces
    const linkUpdate = linkEnter.merge(link);

    linkUpdate.transition()
        .duration(duration)
        .attr('d', d => diagonal(d, d.parent));

    // Transición de salida de enlaces
    link.exit().transition()
        .duration(duration)
        .attr('d', d => {
            const o = { x: source.x, y: source.y };
            return diagonal(o, o);
        })
        .remove();

    // Guardar posición antigua para la transición
    nodes.forEach(d => {
        d.x0 = d.x;
        d.y0 = d.y;
    });
}

// Función para crear enlaces curvos
function diagonal(s, d) {
    return `M ${s.y} ${s.x}
            C ${(s.y + d.y) / 2} ${s.x},
              ${(s.y + d.y) / 2} ${d.x},
              ${d.y} ${d.x}`;
}

// Función de clic
function click(d) {
    if (d.data.url) {
        // Si es un enlace, abrir en nueva pestaña
        window.open(d.data.url, '_blank');
    } else {
        // Si es una categoría, expandir/colapsar
        if (d.children) {
            d._children = d.children;
            d.children = null;
        } else {
            d.children = d._children;
            d._children = null;
        }
        update(d);
    }
}

// Funcionalidad de búsqueda
const searchBox = document.getElementById('searchBox');
searchBox.addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    
    if (searchTerm === '') {
        // Restablecer todos los nodos
        svg.selectAll('g.node').classed('hidden', false);
        svg.selectAll('path.link').classed('hidden', false);
        return;
    }

    // Buscar y resaltar coincidencias
    svg.selectAll('g.node').each(function(d) {
        const node = d3.select(this);
        const matches = d.data.name.toLowerCase().includes(searchTerm);
        node.classed('hidden', !matches);
    });

    svg.selectAll('path.link').each(function(d) {
        const link = d3.select(this);
        const matches = d.data.name.toLowerCase().includes(searchTerm);
        link.classed('hidden', !matches);
    });
});

// Botón de restablecer
document.getElementById('resetBtn').addEventListener('click', function() {
    searchBox.value = '';
    svg.selectAll('g.node').classed('hidden', false);
    svg.selectAll('path.link').classed('hidden', false);
    
    // Colapsar todo excepto el nodo raíz
    if (root.children) {
        root.children.forEach(collapse);
    }
    update(root);
});

// Botón de expandir todo
document.getElementById('expandAllBtn').addEventListener('click', function() {
    expand(root);
    update(root);
});

// Botón de colapsar todo
document.getElementById('collapseAllBtn').addEventListener('click', function() {
    if (root.children) {
        root.children.forEach(collapse);
    }
    update(root);
});

// Hacer el SVG responsivo
window.addEventListener('resize', function() {
    const newContainerWidth = Math.max(treeContainer.clientWidth || window.innerWidth, 320);
    const newWidth = Math.max(newContainerWidth - margin.left - margin.right, 100);
    d3.select("#tree-container svg")
        .attr("width", newWidth + margin.left + margin.right);
});

}

if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initTree);
} else {
    initTree();
}
</script>
